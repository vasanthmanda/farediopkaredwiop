name: 007-of-one Docker Cycle (with IP Gate) (01:30 PM IST)
on:
  schedule:
    # 08:00 UTC = 13:30 IST
    - cron: "0 8 * * *"
  workflow_dispatch:

concurrency:
  group: daily-docker-1-${{ github.ref }}
  cancel-in-progress: false

jobs:
  docker-cycle:
    runs-on: ubuntu-latest
    timeout-minutes: 290
    permissions:
      contents: write

    steps:
      - name: Collect runner public IP (early)
        id: ip
        continue-on-error: true
        env:
          ACC_1: ${{ secrets.ACCOUNT_1 }}
          ACC_2: ${{ secrets.ACCOUNT_2 }}
          ACC_3: ${{ secrets.ACCOUNT_3 }}
        run: |
          echo "JOB_START=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV
          echo "IP=$(curl -s https://api.ipify.org)" >> $GITHUB_ENV

          # Calculate which Account/Script is active today
          # Order: one.sh, two.sh, three.sh
          # Mapping:
          #   Index 0 -> one.sh   -> Use ACCOUNT_1
          #   Index 1 -> two.sh   -> Use ACCOUNT_2
          #   Index 2 -> three.sh -> Use ACCOUNT_3

          DAY_NUM=$(date +%j | sed 's/^0*//') # Remove leading zeros
          INDEX=$(( (DAY_NUM - 1) % 3 ))

          if [ "$INDEX" -eq 0 ]; then
             echo "Using one.sh -> Account 1"
             echo "ACTIVE_ACCOUNT=$ACC_1" >> $GITHUB_ENV
             echo "ACCOUNT_NAME=Account 1" >> $GITHUB_ENV
             echo "TARGET_SCRIPT_URL=${{ secrets.SCRIPT_URL_ONE }}" >> $GITHUB_ENV
             echo "TARGET_RESTORE_URL=${{ secrets.SESSION_RESTORE_URL_ONE }}" >> $GITHUB_ENV
          elif [ "$INDEX" -eq 1 ]; then
             echo "Using two.sh -> Account 2"
             echo "ACTIVE_ACCOUNT=$ACC_2" >> $GITHUB_ENV
             echo "ACCOUNT_NAME=Account 2" >> $GITHUB_ENV
             echo "TARGET_SCRIPT_URL=${{ secrets.SCRIPT_URL_TWO }}" >> $GITHUB_ENV
             echo "TARGET_RESTORE_URL=${{ secrets.SESSION_RESTORE_URL_TWO }}" >> $GITHUB_ENV
          else
             echo "Using three.sh -> Account 3"
             echo "ACTIVE_ACCOUNT=$ACC_3" >> $GITHUB_ENV
             echo "ACCOUNT_NAME=Account 3" >> $GITHUB_ENV
             echo "TARGET_SCRIPT_URL=${{ secrets.SCRIPT_URL_THREE }}" >> $GITHUB_ENV
             echo "TARGET_RESTORE_URL=${{ secrets.SESSION_RESTORE_URL_THREE }}" >> $GITHUB_ENV
          fi

      - name: Send IP to collector (Ingest)
        continue-on-error: true
        env:
          COLLECTOR_URL: ${{ secrets.COLLECTOR_URL }}
          COLLECTOR_TOKEN: ${{ secrets.COLLECTOR_TOKEN }}
          HMAC_SECRET: ${{ secrets.HMAC_SECRET }}
        run: |
          # Use calculated ACTIVE_ACCOUNT or fallback to repo owner
          ACC="${ACTIVE_ACCOUNT:-${{ github.repository_owner }}}"
          # Use ACCOUNT_NAME for the display label in payload
          ACC_LABEL="${ACCOUNT_NAME:-${{ github.repository_owner }}}"

          payload=$(jq -n \
            --arg account  "$ACC" \
            --arg label    "$ACC_LABEL" \
            --arg repo     "${{ github.repository }}" \
            --arg run_id   "${{ github.run_id }}" \
            --arg job      "${{ github.job }}" \
            --arg workflow "${{ github.workflow }}" \
            --arg ip       "${IP:-unknown}" \
            --arg ts       "${JOB_START}" \
            '{account:$account,account_label:$label,repo:$repo,run_id:$run_id,job:$job,workflow:$workflow,ip:$ip,ts:$ts}')

          # Optional: Generate HMAC signature
          sig=$(printf "%s" "$payload" | openssl dgst -sha256 -hmac "$HMAC_SECRET" -binary | base64)

          curl -s -X POST "$COLLECTOR_URL/ingest" \
            -H "Authorization: Bearer $COLLECTOR_TOKEN" \
            -H "Content-Type: application/json" \
            -H "X-Signature: $sig" \
            -d "$payload" || true

      - name: Ask collector if we should run (Gate)
        id: gate
        continue-on-error: true
        env:
          COLLECTOR_URL: ${{ secrets.COLLECTOR_URL }}
          COLLECTOR_TOKEN: ${{ secrets.COLLECTOR_TOKEN }}
          HMAC_SECRET: ${{ secrets.HMAC_SECRET }}
        run: |
          # Use calculated ACTIVE_ACCOUNT or fallback to repo owner
          ACC="${ACTIVE_ACCOUNT:-${{ github.repository_owner }}}"
          # Use ACCOUNT_NAME for the display label in payload
          ACC_LABEL="${ACCOUNT_NAME:-${{ github.repository_owner }}}"

          gate_payload=$(jq -n \
            --arg account  "$ACC" \
            --arg label    "$ACC_LABEL" \
            --arg repo     "${{ github.repository }}" \
            --arg run_id   "${{ github.run_id }}" \
            --arg job      "${{ github.job }}" \
            --arg workflow "${{ github.workflow }}" \
            --arg ip       "${IP:-unknown}" \
            --arg ts       "${JOB_START}" \
            '{account:$account,account_label:$label,repo:$repo,run_id:$run_id,job:$job,workflow:$workflow,ip:$ip,ts:$ts}')

          gate_sig=$(printf "%s" "$gate_payload" | openssl dgst -sha256 -hmac "$HMAC_SECRET" -binary | base64)

          resp=$(curl -s -X POST "$COLLECTOR_URL/gate" \
            -H "Authorization: Bearer $COLLECTOR_TOKEN" \
            -H "Content-Type: application/json" \
            -H "X-Signature: $gate_sig" \
            -d "$gate_payload" || echo '{}')

          should_run=$(echo "$resp" | jq -r '.should_run // "true"')
          reason=$(echo "$resp" | jq -r '.reason // ""')

          echo "Gate decision: should_run=$should_run, reason=$reason"
          echo "SHOULD_RUN=$should_run" >> $GITHUB_ENV
          echo "GATE_REASON=$reason" >> $GITHUB_ENV

      - name: Abort early (Policy Check)
        if: env.SHOULD_RUN != 'true'
        run: |
          echo "Policy triggered: ${{ env.GATE_REASON }}. Skipping project run." >> $GITHUB_STEP_SUMMARY
          exit 0

      # --- Project Steps (Only run if Gate allows) ---

      - name: Checkout repo
        if: env.SHOULD_RUN == 'true'
        uses: actions/checkout@v4

      - name: Make scripts executable
        if: env.SHOULD_RUN == 'true'
        run: |
          chmod +x script.sh

      - name: Run cyclic Docker script
        if: env.SHOULD_RUN == 'true'
        env:
          PROJECT_NAME: '007-of-one'
          SESSION_COPY_DELAY: 5700 # Wait 95 minutes before copying sessions
          ENABLE_SESSION_UPLOAD: 'true' # Set to 'false' to disable artifact upload
          ENABLE_ARTIFACT_UPLOAD: 'true' # Upload as Build Artifact
          ENABLE_RELEASE_UPLOAD: 'false' # Upload to GitHub Release
          ENABLE_SESSION_RESTORE: 'false' # Set to 'true' to enable session restore (and disable upload)
          SESSION_RESTORE_URL_ONE: ${{ secrets.SESSION_RESTORE_URL_ONE }}
          SESSION_RESTORE_URL_TWO: ${{ secrets.SESSION_RESTORE_URL_TWO }}
          SESSION_RESTORE_URL_THREE: ${{ secrets.SESSION_RESTORE_URL_THREE }}
          ACCOUNT_1: ${{ secrets.ACCOUNT_1 }}
          ACCOUNT_2: ${{ secrets.ACCOUNT_2 }}
          ACCOUNT_3: ${{ secrets.ACCOUNT_3 }}
          ARTIFACT_NAME_CUSTOM: ${{ secrets.ARTIFACT_NAME_CUSTOM }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: ./script.sh

      - name: Upload Sessions Artifact
        if: env.SHOULD_RUN == 'true' && env.ENABLE_ARTIFACT_UPLOAD == 'true' && env.ARTIFACT_CREATED == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: sessions.zip
          retention-days: 5

      - name: Prepare Release File
        if: env.SHOULD_RUN == 'true' && env.ENABLE_RELEASE_UPLOAD == 'true' && env.ARTIFACT_CREATED == 'true'
        run: cp sessions.zip "${{ env.ARTIFACT_NAME }}.zip"

      - name: Upload to Release
        if: env.SHOULD_RUN == 'true' && env.ENABLE_RELEASE_UPLOAD == 'true' && env.ARTIFACT_CREATED == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: project-007
          files: "${{ env.ARTIFACT_NAME }}.zip"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
